<html>
<head>
    <title>Git history spike</title>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

    <style type="text/css">
        <!--
        .header {
            background-color: #FFCC33;
        }

        .add {
            background-color: #adff2f;
        }

        .remove {
            background-color: #FFDDDD;
        }

        .line {
            margin: 0 0 0 40px; /*--Left Margin--*/
            font-size: 12px;
            width: 600px;
        }

        -->
    </style>

</head>

<body>

<script type="text/javascript">

    function getURLParameter(name) {
        return decodeURI(
                (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search) || [,null])[1]
        );
    }

    if (typeof String.prototype.startsWith != 'function') {
        String.prototype.startsWith = function (str) {
            return this.indexOf(str) == 0;
        };
    }

    var base_url = "http://github.com";
    var base_api_url = base_url + "/api/v2/json/commits/show";

    var diffAsHtml = function (commit) {
        var diff = "<div>";
        if (commit.modified) {
            for (var i = 0; i < commit.modified.length; i++) {
                var lines = commit.modified[i].diff.split(/\n/g);
                for (var y = 0; y < lines.length; y++) {
                    var modClass = "";
                    if (lines[y].startsWith("+")) {
                        modClass = " add";
                    }
                    if (lines[y].startsWith("-")) {
                        modClass = " remove";
                    }
                    diff += "<div class=\"line" + modClass + "\">" + lines[y].replace(/ /g, "&nbsp;") + "</div>";
                }
            }
        }
        diff += "</div>";
        return diff;
    };

    var displayCommit = function (commit) {
        var diff = diffAsHtml(commit);
        var commitAsHtml = "<div class=\"commit\"><div class=\"header\">" + commit.committer.name + ": " + commit.message + " <a href=\"" + base_url + commit.url + "\"> view </a></div><div>" + diff + "</div></div>";
        $("#msgid").after(commitAsHtml);
    };


    var fetchAndDisplayCommits = function (from, to) {
        var the_url = base_api_url + "/dziemid/refactormycode/" + from;

        $.ajax({
            url: the_url,
            dataType: 'jsonp',
            type: 'get',
            success: function(data) {
                var commit = data.commit;
                displayCommit(commit);

                if (from != to) {
                    fetchAndDisplayCommits(commit.parents[0].id, to);
                }
            }
        });
    };

    $(document).ready(function() {
        var lastCommit = getURLParameter("from");
        var initialCommit = getURLParameter("to");

        //var lastCommit = "c5807472c30485c218a41b7645b43baeeb29704f";
        //var initialCommit = "9e9ef1c11a52580a4624743bfe902d3848d64374";

        fetchAndDisplayCommits(lastCommit, initialCommit);

    });

</script>
<div id="msgid">
    Commits
</div>

</body>
</html>



